{% extends 'base.html' %}

{% block title %}{{ product.product_name }} {% endblock %}

{% block content %}
    <div class="container dark-grey-text mt-5">
      <!--Grid row-->
      <div class="row wow fadeIn">
        <!--Grid column-->
        <div class="col-md-6 mb-4">
          {% if product.image_url %}
          <img src="{{ product.image_url }}" class="img-fluid" alt="Image of {{ product.product_name }}">
          {% else %}
          <!--TODO:Update the Default image-->
          <img src="https://mdbootstrap.com/img/Photos/Horizontal/E-commerce/Products/14.jpg" class="img-fluid" alt="">
          {% endif %}
        </div>
        <!--Grid column-->

        <!--Grid column-->
        <div class="col-md-6 mb-4">
          <!--Content-->
          <div class="p-4">
            <div class="mb-3">
                <span class="badge purple mr-1">{{ product.get_category_display }}</span>
              {% if product.determine_if_new %}
                <span class="badge blue mr-1">New</span>
              {% endif %}
              {% if product.price > 99 %}
                <span class="badge red mr-1">Free Shipping</span>
              {% endif %}
            </div>

            <p class="lead font-weight-bold">{{ product.brand }} {{ product.product_name }}</p>
            {% if product.seller.vendorprofile.store_name %}
            <p class="lead">Sold by: {{ product.seller.vendorprofile.store_name }}</p>
            {% else %}
            <p class="lead">Sold by: {{ product.seller }}</p>
            {% endif %}
            <p class="lead">
              <span><strong>${{ product.price }}</strong></span>
            </p>
            <form class="d-flex justify-content-left" method="POST" action="{% url 'cart:add_to_cart' product.sku %}">
              {% csrf_token %}
              <div class="form-group">
                <div class="input-group align-items-center">
                  <div class="input-group-prepend">
                    <button class="decrement-qty btn btn-sm"
                            data-sku="{{ product.sku }}"
                            id="decrement-qty_{{ product.sku }}">
                      <span class="icon">
                        <i class="fas fa-minus"></i>
                      </span>
                    </button>
                  </div>
                  <input type="number" value="1" min="1" max="20" 
                    aria-label="item quantity" 
                    class="form-control qty_input text-center" 
                    style="width: 60px" 
                    name="quantity"
                    data-sku="{{ product.sku }}"
                    id="id_qty_{{ product.sku }}"
                  />
                  <div class="input-group-append">
                    <button class="increment-qty btn btn-sm"
                            data-sku="{{ product.sku }}"
                            id="increment-qty_{{ product.sku }}">
                      <span class="icon">
                          <i class="fas fa-plus"></i>
                      </span>
                    </button>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <div class="input-group">
                  <button class="btn btn-primary btn-md my-0 p" type="submit">Add to cart
                    <i class="fas fa-shopping-cart ml-1"></i>
                  </button>
                </div>
              </div>
              <input type="hidden" name="redirect_url" value="{{ request.path }}" />
            </form>
            <div class="pt-2">
              {% if request.user == product.seller.user %}
              <h5><strong>Product Owner Details:</strong></h5>
              <p class="text-danger mb-1">The selling fee for your item is ${{ product.get_selling_fee }} per item sold.</p>
              <p class="mb-1">You listed this product for sale on {{ product.date_added|date:"SHORT_DATE_FORMAT" }}.</p>
              <p class="mb-1">
                <a href="" class="button btn btn-primary btn-sm">Modify Product</a>
                <a href="" class="button btn btn-danger btn-sm">Remove Product</a>
              </p>
              {% endif %}
            </div>
          </div>
          <!--Content-->
        </div>
        <!--Grid column-->
      </div>
      <!--Grid row-->
      <hr>
      <!--Product details section-->
      <!--Grid row-->
      <div class="row d-flex wow fadeIn">
        <!--Grid column-->
        <div class="col-md-8">
          <h4 class="my-4 h4">Description:</h4>
          <p>{{ product.description|capfirst }}</p>
          <h4 class="my-4 h4">Additional information about the {{ product.brand }} {{ product.product_name }}:</h4>
          <p>GPU Manufacturer: {{ product.category }}</p>
          <p>Brand: {{ product.brand }}</p>
          <p>Boost Clock Speed: {{ product.boost_clock }}</p>
          <p>Memory Clock Speed: {{ product.memory_clock }}</p>
          <p>Memory Size: {{ product.memory_size }}</p>
          <p>Memory Type: {{ product.memory_type }}</p>
          <p>Interface Type: {{ product.interface_type }}</p>
        </div>
        <!--Grid column-->
      </div>
      <!--Grid row-->

      <!--Product review section-->

      <hr>
      <h4 class="my-4 h4">Product Reviews:</h4>
      {% if reviews.count > 0 %}
      <!--Grid row-->
      <div class="row d-flex wow fadeIn">
        <!--Grid column-->
        {% for review in reviews %}
        <div class="col-md-6 mb-4">
          <div>
            <p class="mb-1">{{ review.title }}</p>
            <p class="small mb-1">Review by: {{ review.added_by.user }} on {{ review.added_on|date:"SHORT_DATE_FORMAT" }}</p>
            <p class="mb-1">Rating: {{ review.rating }} / 5</p>
            <p class="mb-1">{{ review.body_content }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <!--Grid row-->
      <div class="row d-flex wow fadeIn">
        <!-- Test placeholder for collapse control for review Div-->
          <!--Grid column-->
          <div class="col-md-6 mb-2">
            <div>
              <p>There are no reviews for this product yet.  Leave a review now!</p>
            </div>
            <div>
              <button class="button btn btn-primary btn-sm">Leave a Review</button>
            </div>
          </div>
      </div>
      {% endif %}

      <!--Similar product recommendations section-->
      <!--Grid row-->
    {% if product.get_similar_products %}
      <hr>
      <div class="row d-flex wow fadeIn">
        <div class="col">
          <h4 class="my-2 h4">Similar Products:</h4>
          <p>Here are some additional products we think you will love!</p>
        </div>
      </div>
        <div class="row wow fadeIn p-1 d-inline-flex justify-content-sm-center">
          {% for product in product.get_similar_products %}
          <div class="col-md-3">
            <div class="card m-1 p-1">
            <a href="{% url 'product:product_detail' slug=product.slug %}">
              <img src="{{ product.image_url }}" class="img-fluid" alt="{{ product.product_name }}">
              <div class="row text-center">
                <div class="col">
                  {{ product.product_name }}
                </div>
                <div class="col">
                  ${{ product.price|intcomma }}
                </div>
              </div>
            </a>
          </div>
          </div>
          {% endfor %}
        </div>
      <!--Grid row-->
    {% endif %}
{% endblock %}

{% block postloadjs %}

<script type="text/javascript">
  // Disable +/- buttons outside 1-99 range
  function handleEnableDisable(sku) {
      var currentValue = parseInt($(`#id_qty_${sku}`).val());
      var minusDisabled = currentValue < 2;
      var plusDisabled = currentValue > 19;
      $(`#decrement-qty_${sku}`).prop('disabled', minusDisabled);
      $(`#increment-qty_${sku}`).prop('disabled', plusDisabled);
  }

  // Ensure proper enabling/disabling of all inputs on page load
  var allQtyInputs = $('.qty_input');
  for(var i = 0; i < allQtyInputs.length; i++){
      var sku = $(allQtyInputs[i]).data('sku');
      handleEnableDisable(sku);
  }

  // Check enable/disable every time the input is changed
  $('.qty_input').change(function() {
      var sku = $(this).data('sku');
      handleEnableDisable(sku);
  });

  // Increment quantity
  $('.increment-qty').click(function(e) {
     e.preventDefault();
     var closestInput = $(this).closest('.input-group').find('.qty_input')[0];
     var currentValue = parseInt($(closestInput).val());
     $(closestInput).val(currentValue + 1);
     var sku = $(this).data('sku');
     handleEnableDisable(sku);
  });

  // Decrement quantity
  $('.decrement-qty').click(function(e) {
     e.preventDefault();
     var closestInput = $(this).closest('.input-group').find('.qty_input')[0];
     var currentValue = parseInt($(closestInput).val());
     $(closestInput).val(currentValue - 1);
     var sku = $(this).data('sku');
     handleEnableDisable(sku);
  });
</script>
{% endblock %}
